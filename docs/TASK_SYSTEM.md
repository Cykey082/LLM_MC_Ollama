# 后台任务系统文档

## 概述

LLM-MC 现在支持**非阻塞的后台任务执行**，采用**事件驱动**的 LLM 触发机制。这意味着：

- 后台任务独立运行，不阻塞 LLM
- **只有在需要时才触发 LLM**，节省 API 调用
- 玩家聊天时立即响应
- 紧急情况（生命值过低）自动处理

## LLM 触发机制

采用**混合触发**模式，根据是否有后台任务采用不同策略。所有参数都可在 `.env` 中配置：

### 配置项

```env
# 空闲时的决策间隔（秒）
AGENT_TICK_RATE=2.0

# 有后台任务时的定时轮询间隔（秒）
# 设为 0 表示完全事件驱动（只响应聊天/事件）
AGENT_TASK_TICK_RATE=15.0
```

### 空闲状态（无后台任务）

每 **AGENT_TICK_RATE** 秒（默认 2 秒）调用一次 LLM，让 bot 可以：
- 主动巡逻、探索
- 与玩家打招呼
- 观察环境并做出反应

唯一跳过的情况：上次执行了 `wait` 且没有新的聊天/事件

### 有后台任务运行时

采用**混合模式**：

| 情况 | LLM 调用时机 |
|------|-------------|
| 收到聊天消息 | **立即**触发 |
| 游戏事件 | **立即**触发 |
| 紧急情况（生命值<6 或 饥饿值<4） | **立即**触发 |
| 无上述事件 | 每 **AGENT_TASK_TICK_RATE** 秒触发一次 |

如果 `AGENT_TASK_TICK_RATE=0`，则完全事件驱动，无事件时不调用 LLM。

### 设计好处

- **空闲时活跃**：bot 可以主动行动，不是死板地等待
- **任务时节省**：减少不必要的 LLM 调用，但仍可定时检查
- **保持响应性**：有聊天时始终立即响应
- **可配置**：用户可根据需求调整轮询频率

## 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Agent 决策层                              │
│  ┌──────────────────────┐    ┌──────────────────────────────┐  │
│  │   LLM 决策循环        │    │      TaskManager            │  │
│  │   (持续运行)          │◄──►│  - 管理后台任务生命周期       │  │
│  │                       │    │  - 任务状态查询              │  │
│  │   每个 tick:          │    │  - 任务取消                  │  │
│  │   1. 获取观察         │    │  - 进度更新                  │  │
│  │   2. 添加任务状态     │    │                              │  │
│  │   3. 调用 LLM 决策    │    │   ┌────────────────────┐     │  │
│  │   4. 执行动作         │    │   │ Task 1: 挖矿       │     │  │
│  │                       │    │   │ Status: running    │     │  │
│  │   可以:               │    │   │ Progress: 3/10     │     │  │
│  │   - 启动新任务        │    │   └────────────────────┘     │  │
│  │   - 取消任务          │    │   ┌────────────────────┐     │  │
│  │   - 响应聊天          │    │   │ Task 2: 采集       │     │  │
│  └──────────────────────┘    │   │ Status: pending    │     │  │
│                               │   └────────────────────┘     │  │
│                               └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 使用方式

### 1. 游戏内指令

玩家可以在游戏聊天中使用以下指令：

| 指令 | 说明 | 示例 |
|------|------|------|
| `%test 技能名` | 启动后台技能 | `%test 挖矿` |
| `%test 技能名(参数=值)` | 带参数启动 | `%test 挖矿(oreType=iron_ore, count=10)` |
| `%stop` | 停止当前任务 | `%stop` |
| `%status` | 查看任务状态 | `%status` |
| `%skills` | 列出可用技能 | `%skills` |
| `%help` | 显示帮助 | `%help` |

### 2. LLM 动作

LLM 可以使用以下动作管理任务：

#### startSkill - 启动后台技能

```json
{
  "action": "startSkill",
  "parameters": {
    "skillName": "挖矿",
    "kwargs": {
      "oreType": "iron_ore",
      "count": 10
    }
  }
}
```

#### cancelTask - 取消任务

```json
{
  "action": "cancelTask",
  "parameters": {
    "taskId": "abc123",  // 可选，不填则取消当前任务
    "all": false         // 设为 true 取消所有任务
  }
}
```

#### getTaskStatus - 获取任务状态

```json
{
  "action": "getTaskStatus",
  "parameters": {}
}
```

### 3. REST API

#### 获取所有任务

```http
GET /api/tasks
```

响应：
```json
{
  "success": true,
  "status": {
    "has_active_tasks": true,
    "running_count": 1,
    "pending_count": 0,
    "summary": "[运行中] 挖矿: 正在采集 iron_ore (已执行 45.2秒)",
    "tasks": [...]
  },
  "history": [...]
}
```

#### 获取当前任务

```http
GET /api/tasks/current
```

#### 获取指定任务

```http
GET /api/tasks/{task_id}
```

#### 启动技能任务

```http
POST /api/tasks/start-skill
Content-Type: application/json

{
  "skillName": "挖矿",
  "kwargs": {
    "oreType": "diamond_ore",
    "count": 5
  }
}
```

#### 取消任务

```http
POST /api/tasks/{task_id}/cancel
```

#### 取消所有任务

```http
POST /api/tasks/cancel-all
```

## 任务状态

任务有以下状态：

| 状态 | 说明 |
|------|------|
| `pending` | 等待执行 |
| `running` | 正在执行 |
| `completed` | 执行完成 |
| `failed` | 执行失败 |
| `cancelled` | 被取消 |

## LLM 行为

当有后台任务运行时，LLM 会：

1. **在观察中看到任务状态**：
   ```
   === 当前后台任务 ===
   [运行中] 挖矿: 正在采集 iron_ore (已执行 45.2秒)
   ```

2. **收到特殊提示**：系统提示词会包含任务管理指南

3. **可以继续响应**：不需要等待任务完成

4. **可以取消任务**：响应玩家的停止请求

## 与旧版本的区别

| 特性 | 旧版本（阻塞） | 新版本（非阻塞） |
|------|---------------|-----------------|
| 技能执行时 LLM | 暂停 | 继续运行 |
| 响应玩家聊天 | 不能 | 可以 |
| 多任务支持 | 不支持 | 支持（最多3个并发） |
| 任务状态查询 | 不支持 | 支持 |
| 任务取消 | 仅 %stop | 多种方式 |

## 示例场景

### 场景 1：边挖矿边聊天

```
玩家: 帮我挖10个铁矿
Bot: 好的，开始挖矿喵~ (启动后台任务)

[45秒后]
玩家: 挖得怎么样了？
Bot: 已经挖了5个了喵~ 还在努力中！ (查看任务状态并回复)

[2分钟后]
Bot: 铁矿挖完啦！一共挖了10个喵~ (任务完成通知)
```

### 场景 2：紧急中断

```
玩家: 去挖钻石
Bot: 好的，出发挖钻石喵~ (启动后台任务)

[1分钟后]
玩家: 停下！有怪物！
Bot: 收到，停止挖矿！ (取消任务)
Bot: (开始攻击怪物)
```

## 技术细节

### TaskManager 类

位于 `backend/app/task/manager.py`，提供：

- `create_task()`: 创建并启动后台任务
- `cancel_task()`: 取消指定任务
- `cancel_all_tasks()`: 取消所有任务
- `get_task()`: 获取任务详情
- `get_status_summary()`: 获取状态摘要（用于 LLM）
- `update_progress()`: 更新任务进度

### Task 数据类

```python
@dataclass
class Task:
    id: str              # 唯一标识
    name: str            # 任务名称
    description: str     # 描述
    status: TaskStatus   # 状态
    progress: str        # 进度描述
    result: Any          # 执行结果
    error: str           # 错误信息
    created_at: float    # 创建时间
    started_at: float    # 开始时间
    completed_at: float  # 完成时间
    logs: List[str]      # 日志
```

## 注意事项

1. **最大并发数**：默认最多 3 个并发任务
2. **超时时间**：每个任务默认 5 分钟超时
3. **任务历史**：保留最近 20 条任务历史
4. **进度更新**：技能可以调用 `task_manager.update_progress()` 更新进度